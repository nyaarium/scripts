#!/bin/bash

# Load .env from script directory if it exists
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/.env" ]; then
    source "$SCRIPT_DIR/.env"
fi

set -e


mkdir -p ~/"py-envs"
cd ~/"py-envs"

# Create vllm folder if missing
VLLM_DIR="vllm-env"
if [ ! -d "$VLLM_DIR" ]; then
    echo "Creating new vllm-env..."
    python3 -m venv vllm-env
    source vllm-env/bin/activate
    pip install --upgrade pip
    pip install vllm flashinfer-python
else
    source vllm-env/bin/activate
fi


# Ensure Codestral model exists OR let vLLM fetch it automatically
MODEL_DIR="$HOME/.cache/huggingface/hub/models--mistralai--Codestral-22B-v0.1"

if [ ! -d "$MODEL_DIR" ]; then
    echo "Model not found locally. vLLM will download it on first run."
fi


# Start ngrok in background
echo "Starting ngrok tunnel..."
ngrok http 8000 --traffic-policy-file "$HOME/.config/ngrok/policy.yml" > /tmp/ngrok.log 2>&1 &
NGROK_PID=$!

# Cleanup function
_term() {
    echo "Shutting down ngrok..."
    kill $NGROK_PID 2>/dev/null
    exit
}
trap _term EXIT TERM INT


# # Run vLLM with stelterlab/Codestral-22B-v0.1-AWQ
# echo "Starting vLLM OpenAI-compatible server..."
# python -m vllm.entrypoints.openai.api_server \
#     --host 0.0.0.0 \
#     --port 8000 \
#     --api-key "vllm" \
#     --model "stelterlab/Codestral-22B-v0.1-AWQ" \
#     --quantization awq \
#     --tokenizer "mistralai/Codestral-22B-v0.1" \
#     --tokenizer-mode mistral \
#     --chat-template "$SCRIPT_DIR/codestral-chat-template.jinja" \
#     --enable-auto-tool-choice \
#     --tool-call-parser mistral \
#     --gpu-memory-utilization 0.9
#     # --max-model-len 24000


# Run vLLM with Qwen2.5
echo "Starting vLLM OpenAI-compatible server..."
python -m vllm.entrypoints.openai.api_server \
    --host 0.0.0.0 \
    --port 8000 \
    --api-key "vllm" \
    --model "Qwen/Qwen2.5-14B-Instruct-AWQ" \
    --quantization awq \
    --enable-auto-tool-choice \
    --tool-call-parser qwen3_xml \
    --gpu-memory-utilization 0.9
    # --max-model-len 24000
